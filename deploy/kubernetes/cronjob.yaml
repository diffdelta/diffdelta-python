# DiffDelta Agent — Kubernetes CronJob.
#
# Runs every 15 minutes, polls for changes, posts to your integration.
# Cursor is persisted in a PVC so you never see duplicate alerts.
#
# Setup:
#   1. Build the image (from diffdelta-python root):
#        docker build -f deploy/Dockerfile -t your-registry/diffdelta-agent:latest .
#        docker push your-registry/diffdelta-agent:latest
#
#   2. Create the secret:
#        kubectl create secret generic diffdelta-secrets \
#          --from-literal=SLACK_WEBHOOK_URL="https://hooks.slack.com/services/..."
#
#   3. Apply:
#        kubectl apply -f cronjob.yaml

apiVersion: batch/v1
kind: CronJob
metadata:
  name: diffdelta-agent
  labels:
    app: diffdelta
spec:
  schedule: "*/15 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        spec:
          restartPolicy: OnFailure
          containers:
            - name: agent
              # Use the pre-built image (diffdelta + recipes baked in).
              # No pip install on every run — fast, reliable, offline-safe.
              image: your-registry/diffdelta-agent:latest
              command: ["python", "/app/recipes/run.py", "slack_alerts", "--once"]
              envFrom:
                - secretRef:
                    name: diffdelta-secrets
              env:
                - name: DD_CURSOR_PATH
                  value: /data/cursors.json
              volumeMounts:
                - name: cursors
                  mountPath: /data
          volumes:
            - name: cursors
              persistentVolumeClaim:
                claimName: diffdelta-cursors

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: diffdelta-cursors
spec:
  accessModes: [ReadWriteOnce]
  resources:
    requests:
      storage: 10Mi
